# ğŸ—„ï¸ ê¹€í”„ ì „ëµ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (Ver 3.0)

## 1. ìŠ¤í‚¤ë§ˆ ê°œìš”

### 1.1 í…Œì´ë¸” êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ê¹€í”„ ì „ëµ DB ìŠ¤í‚¤ë§ˆ (Ver 3.0)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ kimp_ticks  â”‚     â”‚  kimp_1m    â”‚     â”‚ fx_rates    â”‚ [NEW]     â”‚
â”‚   â”‚ (ì‹¤ì‹œê°„)     â”‚ â†’   â”‚  (1ë¶„ë´‰)    â”‚     â”‚ (í™˜ìœ¨)      â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                           â”‚                      â”‚                    â”‚
â”‚                           â–¼                      â–¼                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                    â”‚ zscore_log  â”‚        â”‚ fx_filter   â”‚ [NEW]     â”‚
â”‚                    â”‚ (Z-Score)   â”‚        â”‚ (í™˜ìœ¨í•„í„°)  â”‚           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ positions   â”‚ â†   â”‚  trades     â”‚     â”‚ bb_log      â”‚ [NEW]     â”‚
â”‚   â”‚ (í¬ì§€ì…˜)    â”‚     â”‚ (ê±°ë˜ê¸°ë¡)  â”‚     â”‚ (ë³¼ë¦°ì €)    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 í…Œì´ë¸” ëª©ë¡

| í…Œì´ë¸” | ì„¤ëª… | ë²„ì „ | ì˜ˆìƒ ìš©ëŸ‰ |
|:---|:---|:---|:---|
| `kimp_ticks` | ì‹¤ì‹œê°„ ê¹€í”„ ë°ì´í„° | 1.0 | ~10GB/ë…„ |
| `kimp_1m` | 1ë¶„ë´‰ ì§‘ê³„ ë°ì´í„° | 1.0 | ~500MB/ë…„ |
| `fx_rates` | TradingView í™˜ìœ¨ ë°ì´í„° | **3.0** | ~200MB/ë…„ |
| `fx_filter_log` | í™˜ìœ¨ í•„í„° ìƒíƒœ ë¡œê·¸ | **3.0** | ~50MB/ë…„ |
| `zscore_log` | Z-Score ê³„ì‚° ë¡œê·¸ | 1.0 | ~100MB/ë…„ |
| `bb_log` | ë³¼ë¦°ì € ë°´ë“œ ë¡œê·¸ | **3.0** | ~100MB/ë…„ |
| `positions` | í˜„ì¬ í¬ì§€ì…˜ | 1.0â†’**3.0** | ~1MB |
| `trades` | ê±°ë˜ ê¸°ë¡ | 1.0 | ~10MB/ë…„ |
| `orders` | ì£¼ë¬¸ ê¸°ë¡ | 1.0 | ~20MB/ë…„ |

---

## 2. ì‹ ê·œ í…Œì´ë¸” (Ver 3.0)

### 2.1 fx_rates (TradingView í™˜ìœ¨ ë°ì´í„°)

```sql
CREATE TABLE fx_rates (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    
    -- TradingView ì‹¬ë³¼
    symbol          VARCHAR(30) NOT NULL DEFAULT 'FX_IDC:USDKRW',
    
    -- í™˜ìœ¨ ë°ì´í„°
    rate            DECIMAL(10, 4) NOT NULL,  -- USD/KRW
    
    -- ì´ë™í‰ê·  (12ì‹œê°„ = 720ë¶„)
    ma_12h          DECIMAL(10, 4),
    
    -- ë°ì´í„° ì†ŒìŠ¤ ë©”íƒ€
    source          VARCHAR(20) NOT NULL DEFAULT 'TradingView',
    
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(symbol, timestamp)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_fx_rates_timestamp ON fx_rates(timestamp DESC);
CREATE INDEX idx_fx_rates_symbol_ts ON fx_rates(symbol, timestamp DESC);

-- íŒŒí‹°ì…”ë‹ (ì›”ë³„)
-- CREATE TABLE fx_rates_2025_12 PARTITION OF fx_rates
--     FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

### 2.2 fx_filter_log (í™˜ìœ¨ í•„í„° ìƒíƒœ)

```sql
CREATE TABLE fx_filter_log (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    
    -- í˜„ì¬ í™˜ìœ¨ ìƒíƒœ
    current_rate    DECIMAL(10, 4) NOT NULL,
    ma_12h          DECIMAL(10, 4) NOT NULL,
    threshold       DECIMAL(10, 4) NOT NULL,  -- ma_12h * 1.001
    
    -- í•„í„° ê²°ê³¼
    is_blocked      BOOLEAN NOT NULL,  -- TRUE = ì§„ì… ì°¨ë‹¨
    surge_pct       DECIMAL(10, 4),    -- ê¸‰ë“±ë¥  (%)
    
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_fx_filter_timestamp ON fx_filter_log(timestamp DESC);
CREATE INDEX idx_fx_filter_blocked ON fx_filter_log(is_blocked, timestamp DESC);
```

### 2.3 bb_log (ë³¼ë¦°ì € ë°´ë“œ ë¡œê·¸)

```sql
CREATE TABLE bb_log (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    
    -- ë³¼ë¦°ì € ë°´ë“œ ê°’ (ê¹€í”„ % ê¸°ë°˜)
    bb_upper        DECIMAL(10, 4) NOT NULL,
    bb_middle       DECIMAL(10, 4) NOT NULL,
    bb_lower        DECIMAL(10, 4) NOT NULL,
    
    -- í˜„ì¬ ê¹€í”„
    kimp_current    DECIMAL(10, 4) NOT NULL,
    
    -- ëŒíŒŒ ìƒíƒœ
    is_upper_break  BOOLEAN DEFAULT FALSE,  -- ìƒë‹¨ ëŒíŒŒ ì—¬ë¶€
    is_lower_break  BOOLEAN DEFAULT FALSE,  -- í•˜ë‹¨ ëŒíŒŒ ì—¬ë¶€
    
    -- íŒŒë¼ë¯¸í„°
    period          INTEGER NOT NULL DEFAULT 20,
    std_mult        DECIMAL(4, 2) NOT NULL DEFAULT 2.0,
    
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_bb_log_timestamp ON bb_log(timestamp DESC);
CREATE INDEX idx_bb_log_upper_break ON bb_log(is_upper_break, timestamp DESC);
```

---

## 3. ìˆ˜ì •ëœ í…Œì´ë¸” (Ver 3.0)

### 3.1 positions (exit_reason í•„ë“œ ì¶”ê°€)

```sql
-- ê¸°ì¡´ í…Œì´ë¸”ì— Ver 3.0 í•„ë“œ ì¶”ê°€
ALTER TABLE positions 
ADD COLUMN IF NOT EXISTS exit_reason VARCHAR(20);

-- exit_reason ê°’:
-- 'Target'    : Track A - ì •ìƒ ëª©í‘œê°€(0.7%) ë„ë‹¬
-- 'Breakout'  : Track B - BB ìƒë‹¨ ëŒíŒŒ + 0.48% ì´ìƒ

-- ì „ì²´ ìŠ¤í‚¤ë§ˆ
CREATE TABLE positions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    status          VARCHAR(20) NOT NULL DEFAULT 'open',
    
    -- ì§„ì… ì •ë³´
    entry_level     VARCHAR(10) NOT NULL,  -- 'level1', 'level2', 'combined'
    entry_timestamp TIMESTAMPTZ NOT NULL,
    entry_kimp      DECIMAL(10, 4) NOT NULL,
    entry_zscore    DECIMAL(10, 4) NOT NULL,
    
    -- í™˜ìœ¨ í•„í„° ìƒíƒœ (Ver 3.0)
    entry_fx_rate   DECIMAL(10, 4),        -- ì§„ì… ì‹œì  í™˜ìœ¨
    entry_fx_ma     DECIMAL(10, 4),        -- ì§„ì… ì‹œì  í™˜ìœ¨ MA
    
    -- ì—…ë¹„íŠ¸ í¬ì§€ì…˜
    upbit_amount    DECIMAL(20, 8) NOT NULL,
    upbit_price     DECIMAL(20, 2) NOT NULL,
    upbit_order_id  VARCHAR(100),
    
    -- ë°”ì´ë‚¸ìŠ¤ í¬ì§€ì…˜
    binance_amount  DECIMAL(20, 8) NOT NULL,
    binance_price   DECIMAL(20, 8) NOT NULL,
    binance_order_id VARCHAR(100),
    
    -- ì´ íˆ¬ì…ê¸ˆ
    total_invested  DECIMAL(20, 2) NOT NULL,
    
    -- ì²­ì‚° ì •ë³´ (Ver 3.0 ì—…ë°ì´íŠ¸)
    exit_timestamp  TIMESTAMPTZ,
    exit_kimp       DECIMAL(10, 4),
    exit_reason     VARCHAR(20),  -- 'Target' or 'Breakout' [NEW]
    exit_bb_upper   DECIMAL(10, 4),  -- ì²­ì‚° ì‹œì  BB ìƒë‹¨ [NEW]
    
    -- ì†ìµ
    realized_pnl    DECIMAL(20, 2),
    realized_pnl_pct DECIMAL(10, 4),
    
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- exit_reason ì¸ë±ìŠ¤
CREATE INDEX idx_positions_exit_reason ON positions(exit_reason);
```

### 3.2 zscore_log (5ë¶„ lookback ì¶”ê°€)

```sql
-- ê¸°ì¡´ í…Œì´ë¸”ì— 5ë¶„ ìµœì € Z-Score í•„ë“œ ì¶”ê°€
ALTER TABLE zscore_log 
ADD COLUMN IF NOT EXISTS zscore_5m_min DECIMAL(10, 4);

-- ì „ì²´ ìŠ¤í‚¤ë§ˆ
CREATE TABLE zscore_log (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    
    -- Z-Score ê³„ì‚°ê°’
    kimp_current    DECIMAL(10, 4) NOT NULL,
    kimp_mean       DECIMAL(10, 4) NOT NULL,
    kimp_std        DECIMAL(10, 4) NOT NULL,
    zscore          DECIMAL(10, 4) NOT NULL,
    
    -- 5ë¶„ Lookback ìµœì €ê°’ (Ver 3.0)
    zscore_5m_min   DECIMAL(10, 4),  -- ìµœê·¼ 5ë¶„ê°„ ìµœì € Z-Score
    
    -- íŒŒë¼ë¯¸í„°
    window_size     INTEGER NOT NULL DEFAULT 20,
    
    -- ì‹ í˜¸ ìƒíƒœ
    level1_triggered BOOLEAN DEFAULT FALSE,
    level2_triggered BOOLEAN DEFAULT FALSE,
    
    -- íšŒê·€ ê°ì§€ (Ver 3.0)
    level1_reversion BOOLEAN DEFAULT FALSE,  -- -2.0 íšŒê·€ ë°œìƒ
    level2_reversion BOOLEAN DEFAULT FALSE,  -- -2.5 íšŒê·€ ë°œìƒ
    
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_zscore_log_timestamp ON zscore_log(timestamp DESC);
CREATE INDEX idx_zscore_log_zscore ON zscore_log(zscore);
CREATE INDEX idx_zscore_log_reversion ON zscore_log(level1_reversion, level2_reversion);
```

---

## 4. ê¸°ì¡´ í…Œì´ë¸” (ë³€ê²½ ì—†ìŒ)

### 4.1 kimp_ticks (ì‹¤ì‹œê°„ ë°ì´í„°)

```sql
CREATE TABLE kimp_ticks (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    
    -- ì—…ë¹„íŠ¸ ë°ì´í„°
    upbit_price     DECIMAL(20, 2) NOT NULL,
    upbit_volume    DECIMAL(20, 8),
    
    -- ë°”ì´ë‚¸ìŠ¤ ë°ì´í„°
    binance_price   DECIMAL(20, 8) NOT NULL,
    binance_volume  DECIMAL(20, 8),
    
    -- í™˜ìœ¨
    exchange_rate   DECIMAL(10, 4) NOT NULL,
    
    -- ê¹€í”„ ê³„ì‚°ê°’
    kimp_percent    DECIMAL(10, 4) NOT NULL,
    
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_kimp_ticks_timestamp ON kimp_ticks(timestamp DESC);
CREATE INDEX idx_kimp_ticks_symbol_ts ON kimp_ticks(symbol, timestamp DESC);
```

### 4.2 kimp_1m (1ë¶„ë´‰ ë°ì´í„°)

```sql
CREATE TABLE kimp_1m (
    id              BIGSERIAL PRIMARY KEY,
    timestamp       TIMESTAMPTZ NOT NULL,
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    
    -- OHLC
    kimp_open       DECIMAL(10, 4) NOT NULL,
    kimp_high       DECIMAL(10, 4) NOT NULL,
    kimp_low        DECIMAL(10, 4) NOT NULL,
    kimp_close      DECIMAL(10, 4) NOT NULL,
    
    -- í‰ê·  ê°€ê²©
    upbit_avg       DECIMAL(20, 2) NOT NULL,
    binance_avg     DECIMAL(20, 8) NOT NULL,
    exchange_rate   DECIMAL(10, 4) NOT NULL,
    
    -- ê±°ë˜ëŸ‰
    volume          DECIMAL(20, 8),
    tick_count      INTEGER,
    
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(symbol, timestamp)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_kimp_1m_timestamp ON kimp_1m(timestamp DESC);
CREATE INDEX idx_kimp_1m_symbol_ts ON kimp_1m(symbol, timestamp DESC);
```

### 4.3 trades (ê±°ë˜ ê¸°ë¡)

```sql
CREATE TABLE trades (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    position_id     UUID REFERENCES positions(id),
    symbol          VARCHAR(20) NOT NULL DEFAULT 'BTC',
    
    -- ê±°ë˜ ìœ í˜•
    trade_type      VARCHAR(10) NOT NULL,  -- 'entry', 'exit', 'rollback'
    side            VARCHAR(10) NOT NULL,  -- 'buy', 'sell'
    exchange        VARCHAR(20) NOT NULL,  -- 'upbit', 'binance'
    
    -- ì£¼ë¬¸ ì •ë³´
    order_id        VARCHAR(100),
    order_type      VARCHAR(20) NOT NULL,  -- 'market', 'limit'
    
    -- ì²´ê²° ì •ë³´
    amount          DECIMAL(20, 8) NOT NULL,
    price           DECIMAL(20, 8) NOT NULL,
    filled_amount   DECIMAL(20, 8) NOT NULL,
    avg_price       DECIMAL(20, 8) NOT NULL,
    
    -- ë¹„ìš©
    fee             DECIMAL(20, 8),
    fee_currency    VARCHAR(10),
    
    -- ìƒíƒœ
    status          VARCHAR(20) NOT NULL,  -- 'pending', 'filled', 'canceled', 'failed'
    error_message   TEXT,
    
    executed_at     TIMESTAMPTZ NOT NULL,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_trades_position_id ON trades(position_id);
CREATE INDEX idx_trades_executed_at ON trades(executed_at DESC);
CREATE INDEX idx_trades_exchange ON trades(exchange, executed_at DESC);
```

---

## 5. ë·° (Views)

### 5.1 í˜„ì¬ í¬ì§€ì…˜ + íƒˆì¶œ ì¡°ê±´ ëª¨ë‹ˆí„°ë§ (Ver 3.0)

```sql
CREATE OR REPLACE VIEW v_position_exit_status AS
SELECT 
    p.*,
    k.kimp_close AS current_kimp,
    z.zscore AS current_zscore,
    b.bb_upper AS current_bb_upper,
    
    -- ìˆ˜ìµë¥  ê³„ì‚°
    (k.kimp_close - p.entry_kimp) AS kimp_change,
    
    -- Track A: ì •ìƒ ìµì ˆ ì¡°ê±´
    CASE 
        WHEN (k.kimp_close - p.entry_kimp) >= 0.7 THEN TRUE 
        ELSE FALSE 
    END AS target_exit_ready,
    
    -- Track B: Breakout íƒˆì¶œ ì¡°ê±´
    CASE 
        WHEN (k.kimp_close - p.entry_kimp) >= 0.48 
             AND k.kimp_close > b.bb_upper THEN TRUE 
        ELSE FALSE 
    END AS breakout_exit_ready

FROM positions p
LEFT JOIN LATERAL (
    SELECT kimp_close 
    FROM kimp_1m 
    WHERE symbol = p.symbol 
    ORDER BY timestamp DESC 
    LIMIT 1
) k ON TRUE
LEFT JOIN LATERAL (
    SELECT zscore 
    FROM zscore_log 
    WHERE symbol = p.symbol 
    ORDER BY timestamp DESC 
    LIMIT 1
) z ON TRUE
LEFT JOIN LATERAL (
    SELECT bb_upper 
    FROM bb_log 
    WHERE symbol = p.symbol 
    ORDER BY timestamp DESC 
    LIMIT 1
) b ON TRUE
WHERE p.status = 'open';
```

### 5.2 í™˜ìœ¨ í•„í„° ìƒíƒœ ëª¨ë‹ˆí„°ë§

```sql
CREATE OR REPLACE VIEW v_fx_filter_status AS
SELECT 
    f.timestamp,
    f.current_rate,
    f.ma_12h,
    f.threshold,
    f.is_blocked,
    f.surge_pct,
    CASE 
        WHEN f.is_blocked THEN 'ğŸš« ì§„ì… ì°¨ë‹¨'
        ELSE 'âœ… ì§„ì… ê°€ëŠ¥'
    END AS status_text
FROM fx_filter_log f
ORDER BY f.timestamp DESC
LIMIT 1;
```

### 5.3 ì²­ì‚° ì´ìœ ë³„ í†µê³„

```sql
CREATE OR REPLACE VIEW v_exit_reason_stats AS
SELECT 
    exit_reason,
    COUNT(*) AS trade_count,
    SUM(realized_pnl) AS total_pnl,
    AVG(realized_pnl_pct) AS avg_pnl_pct,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS pct_of_trades
FROM positions
WHERE status = 'closed' AND exit_reason IS NOT NULL
GROUP BY exit_reason
ORDER BY trade_count DESC;
```

---

## 6. í•¨ìˆ˜ (Functions)

### 6.1 í™˜ìœ¨ ê¸‰ë“± ì²´í¬ í•¨ìˆ˜ (Ver 3.0)

```sql
CREATE OR REPLACE FUNCTION check_fx_surge(
    p_current_rate DECIMAL,
    p_ma_12h DECIMAL,
    p_threshold DECIMAL DEFAULT 1.001
) RETURNS BOOLEAN AS $$
BEGIN
    RETURN p_current_rate > (p_ma_12h * p_threshold);
END;
$$ LANGUAGE plpgsql;

-- ì‚¬ìš© ì˜ˆì‹œ
-- SELECT check_fx_surge(1350.0, 1345.0, 1.001);  -- TRUE (ì°¨ë‹¨)
```

### 6.2 ë³¼ë¦°ì € ë°´ë“œ ìƒë‹¨ ëŒíŒŒ ì²´í¬

```sql
CREATE OR REPLACE FUNCTION check_bb_breakout(
    p_current_kimp DECIMAL,
    p_bb_upper DECIMAL,
    p_entry_kimp DECIMAL,
    p_min_profit DECIMAL DEFAULT 0.48
) RETURNS BOOLEAN AS $$
BEGIN
    -- ì¡°ê±´ 1: ìµœì†Œ ë§ˆì§„ í™•ë³´
    -- ì¡°ê±´ 2: BB ìƒë‹¨ ëŒíŒŒ
    RETURN (p_current_kimp - p_entry_kimp) >= p_min_profit 
           AND p_current_kimp > p_bb_upper;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

### 7.1 Ver 2.0 â†’ Ver 3.0 ë§ˆì´ê·¸ë ˆì´ì…˜

```sql
-- 1. ì‹ ê·œ í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS fx_rates (...);
CREATE TABLE IF NOT EXISTS fx_filter_log (...);
CREATE TABLE IF NOT EXISTS bb_log (...);

-- 2. positions í…Œì´ë¸” í•„ë“œ ì¶”ê°€
ALTER TABLE positions 
ADD COLUMN IF NOT EXISTS exit_reason VARCHAR(20),
ADD COLUMN IF NOT EXISTS exit_bb_upper DECIMAL(10, 4),
ADD COLUMN IF NOT EXISTS entry_fx_rate DECIMAL(10, 4),
ADD COLUMN IF NOT EXISTS entry_fx_ma DECIMAL(10, 4);

-- 3. zscore_log í…Œì´ë¸” í•„ë“œ ì¶”ê°€
ALTER TABLE zscore_log 
ADD COLUMN IF NOT EXISTS zscore_5m_min DECIMAL(10, 4),
ADD COLUMN IF NOT EXISTS level1_reversion BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS level2_reversion BOOLEAN DEFAULT FALSE;

-- 4. ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS idx_positions_exit_reason ON positions(exit_reason);
CREATE INDEX IF NOT EXISTS idx_zscore_log_reversion ON zscore_log(level1_reversion, level2_reversion);

-- 5. ë·° ì¬ìƒì„±
DROP VIEW IF EXISTS v_position_exit_status;
CREATE VIEW v_position_exit_status AS ...;
```

---

**ë²„ì „**: 3.0  
**ì‘ì„±ì¼**: 2025-12-14  
**ë ˆí¬**: trading-platform-storage
